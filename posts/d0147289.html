<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"du2279664786.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":"true#false","color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="CCF BDCI Web攻击检测与分类识别 Top8思路">
<meta property="og:type" content="article">
<meta property="og:title" content="Web攻击检测与分类识别思路">
<meta property="og:url" content="https://du2279664786.github.io/posts/d0147289.html">
<meta property="og:site_name" content="江东的笔记">
<meta property="og:description" content="CCF BDCI Web攻击检测与分类识别 Top8思路">
<meta property="og:locale">
<meta property="og:image" content="https://s2.loli.net/2022/12/05/FHOr3m67MXeTv4w.png">
<meta property="og:image" content="https://s2.loli.net/2022/12/05/2x7AWXbvuoigw8n.png">
<meta property="article:published_time" content="2022-12-05T14:55:10.000Z">
<meta property="article:modified_time" content="2022-12-05T04:20:40.266Z">
<meta property="article:author" content="江东">
<meta property="article:tag" content="数据挖掘">
<meta property="article:tag" content="文本挖掘">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/12/05/FHOr3m67MXeTv4w.png">

<link rel="canonical" href="https://du2279664786.github.io/posts/d0147289.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Web攻击检测与分类识别思路 | 江东的笔记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="江东的笔记" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>
<a target="_blank" rel="noopener" href="https://github.com/du2279664786" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#64CEAA; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">江东的笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Be overcome difficulties is victory</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://du2279664786.github.io/posts/d0147289.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/76576534?v=4">
      <meta itemprop="name" content="江东">
      <meta itemprop="description" content="热爱生活，努力工作">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="江东的笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Web攻击检测与分类识别思路
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-05 22:55:10 / 修改时间：12:20:40" itemprop="dateCreated datePublished" datetime="2022-12-05T22:55:10+08:00">2022-12-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AB%9E%E8%B5%9B/" itemprop="url" rel="index"><span itemprop="name">竞赛</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>CCF BDCI Web攻击检测与分类识别 Top8思路</p>
<span id="more"></span>

<h1 id="CCF-BDCI-Web攻击检测与分类识别-Top8思路"><a href="#CCF-BDCI-Web攻击检测与分类识别-Top8思路" class="headerlink" title="CCF BDCI Web攻击检测与分类识别 Top8思路"></a>CCF BDCI Web攻击检测与分类识别 Top8思路</h1><p><strong>赛题地址</strong>：<a target="_blank" rel="noopener" href="https://www.datafountain.cn/competitions/596">https://www.datafountain.cn/competitions/596</a></p>
<p><img src="https://s2.loli.net/2022/12/05/FHOr3m67MXeTv4w.png" alt="Snipaste_2022-12-05_12-05-48.png"></p>
<h2 id="赛题背景："><a href="#赛题背景：" class="headerlink" title="赛题背景："></a>赛题背景：</h2><p>某业务平台平均每月捕获到Web攻击数量超过2亿，涉及常见注入攻击，代码执行等类型。传统威胁检测手段通过分析已知攻击特征进行规则匹配，无法检测未知漏洞或攻击手法。如何快速准确地识别未知威胁攻击并且将不同攻击正确分类，对提升Web攻击检测能力至关重要。利用机器学习和深度学习技术对攻击报文进行识别和分类已经成为解决该问题的创新思路，有利于推动AI技术在威胁检测分析场景的研究与应用。</p>
<h2 id="赛题任务："><a href="#赛题任务：" class="headerlink" title="赛题任务："></a>赛题任务：</h2><p>参赛团队需要对前期提供的训练集进行分析，通过特征工程、机器学习和深度学习等方法构建AI模型，实现对每一条样本正确且快速分类，不断提高模型精确率和召回率。待模型优化稳定后，通过无标签测试集评估各参赛团队模型分类效果，以正确率评估各参赛团队模型质量。</p>
<h2 id="决赛答辩："><a href="#决赛答辩：" class="headerlink" title="决赛答辩："></a>决赛答辩：</h2><p>决赛答辩中，评审专家将根据答辩作品的创新性、可用性等进行打分；最终成绩将综合考虑初赛成绩、创新性、可用性等方面确定最终排名，最终成绩 &#x3D; 初赛复现成绩 * 80% + 决赛成绩 * 20%。<br>注意，答辩着重考察以下方面：<br>(1) 模型发现未知攻击类型的能力<br>(2) 模型的时间复杂度<br>(3) 其他创新</p>
<h2 id="数据简介"><a href="#数据简介" class="headerlink" title="数据简介"></a>数据简介</h2><p>赛题训练集分为6种不同标签，共计约3.5万条数据。训练数据集字段内容主要包括：<br>●　ID：样本编号<br>●　label：攻击类型编号<br>●　其他：HTTP协议内容</p>
<h2 id="评测标准"><a href="#评测标准" class="headerlink" title="评测标准"></a>评测标准</h2><p>评比期间将提供无标签测试集，参赛团队需提交对该测试集每条数据的模型分类结果，即每条数据中增加一个predict字段（模型分类结果），与训练集label字段含义保持一致。<br>评估程序将模型预测结果predict与标准答案label对比，统计精确率、召回率和F1，最终以F1为准。</p>
<table>
<thead>
<tr>
<th align="center">标签</th>
<th align="center">分类为正标签</th>
<th align="center">分类为负标签</th>
</tr>
</thead>
<tbody><tr>
<td align="center">正标签</td>
<td align="center">TP</td>
<td align="center">FN</td>
</tr>
<tr>
<td align="center">负标签</td>
<td align="center">FP</td>
<td align="center">TN</td>
</tr>
</tbody></table>
<p>精确率计算公式：Precision &#x3D; TP&#x2F;(TP + FP)<br>召回率计算公式：Recall &#x3D; TP&#x2F;(TP + FN)<br>F1计算公式：F1 &#x3D; 2 * Precision * Recall&#x2F;(Precision + Recall)<br>注：该F1为 macro F1</p>
<h1 id="代码如下"><a href="#代码如下" class="headerlink" title="代码如下"></a>代码如下</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lgb删掉tfidf+refer：线下0.9644，线上0.95997</span></span><br><span class="line"><span class="comment"># lgb未删tfidf+refer：线下0.96432，线上0.95828</span></span><br><span class="line"><span class="comment"># xgb:线下0.96494</span></span><br><span class="line"><span class="comment"># cat:线下9650，线上0.9613</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> lightgbm <span class="keyword">import</span> early_stopping</span><br><span class="line"><span class="keyword">from</span> lightgbm <span class="keyword">import</span> log_evaluation</span><br><span class="line"><span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> TruncatedSVD</span><br><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score,f1_score</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> StratifiedKFold</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> LabelEncoder</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> user_agents <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> classification_report</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> confusion_matrix</span><br><span class="line"><span class="keyword">from</span> catboost <span class="keyword">import</span> CatBoostClassifier</span><br><span class="line"><span class="keyword">from</span> xgboost <span class="keyword">import</span> XGBClassifier</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote, unquote, urlparse</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> glob  </span><br><span class="line"></span><br><span class="line">pd.set_option(<span class="string">&#x27;display.max_columns&#x27;</span>, <span class="literal">None</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># iPhone的UserAgent</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ua</span>(<span class="params">row</span>):</span><br><span class="line">    user_agent = parse(row[<span class="string">&#x27;user_agent&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    browser_family=<span class="built_in">str</span>(user_agent.browser.family)</span><br><span class="line">    os_family=<span class="built_in">str</span>(user_agent.os.family)</span><br><span class="line">    device_family=<span class="built_in">str</span>(user_agent.device.family)</span><br><span class="line">    device_brand=<span class="built_in">str</span>(user_agent.device.brand)</span><br><span class="line">    device_model=<span class="built_in">str</span>(user_agent.device.model)</span><br><span class="line">    <span class="keyword">return</span> browser_family,os_family,device_family,device_brand,device_model</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prob = np.load(<span class="string">&#x27;E://data//DF//Web攻击检测与分类识别//large/deberta-v3-large_probs.npy&#x27;</span>)</span><br><span class="line">prob.shape</span><br></pre></td></tr></table></figure>




<pre><code>(4000, 6)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">train=pd.read_pickle(<span class="string">&#x27;E:\\data\\DF\\Web攻击检测与分类识别/large/oof_df.pkl&#x27;</span>)     <span class="comment"># 33037 rows × 15 columns</span></span><br><span class="line">sub = pd.read_csv(<span class="string">&#x27;E:\\data\\DF\\Web攻击检测与分类识别\\submit_example (10).csv&#x27;</span>)</span><br><span class="line"></span><br><span class="line">test=pd.read_csv(<span class="string">&#x27;E:\\data\\DF\\Web攻击检测与分类识别/test.csv&#x27;</span>)</span><br><span class="line">train.head()</span><br></pre></td></tr></table></figure>






<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>method</th>
      <th>user_agent</th>
      <th>url</th>
      <th>refer</th>
      <th>body</th>
      <th>label</th>
      <th>text</th>
      <th>fold</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13429</td>
      <td>GET</td>
      <td>'||(select 1 from (select pg_sleep(8))x)||'</td>
      <td>/kelev/scripts/?C=M%3BO%3DA</td>
      <td>NAN</td>
      <td>GET /kelev/scripts/?C=M%3BO%3DA HTTP/1.1 Accep...</td>
      <td>1</td>
      <td>method:GET[SEP]user_agent:'||(select 1 from (s...</td>
      <td>0</td>
      <td>0.000238</td>
      <td>0.999110</td>
      <td>0.000445</td>
      <td>0.000058</td>
      <td>0.000040</td>
      <td>0.000110</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18125</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2102K1C B...</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>NAN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;...</td>
      <td>1</td>
      <td>method:GET[SEP]user_agent:Dalvik/2.1.0 (Linux;...</td>
      <td>0</td>
      <td>0.006598</td>
      <td>0.992451</td>
      <td>0.000763</td>
      <td>0.000086</td>
      <td>0.000067</td>
      <td>0.000035</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14538</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2011K2C B...</td>
      <td>/livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudid=d2...</td>
      <td>NAN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudi...</td>
      <td>1</td>
      <td>method:GET[SEP]user_agent:Dalvik/2.1.0 (Linux;...</td>
      <td>0</td>
      <td>0.000783</td>
      <td>0.999017</td>
      <td>0.000138</td>
      <td>0.000031</td>
      <td>0.000017</td>
      <td>0.000013</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7127</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 10; MI 9 MIUI/...</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>NAN</td>
      <td>NAN</td>
      <td>1</td>
      <td>method:GET[SEP]user_agent:Dalvik/2.1.0 (Linux;...</td>
      <td>0</td>
      <td>0.007603</td>
      <td>0.991491</td>
      <td>0.000725</td>
      <td>0.000087</td>
      <td>0.000062</td>
      <td>0.000033</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 10; ELS-AN00 B...</td>
      <td>/livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid=&amp;ty...</td>
      <td>NAN</td>
      <td>GET /livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid...</td>
      <td>1</td>
      <td>method:GET[SEP]user_agent:Dalvik/2.1.0 (Linux;...</td>
      <td>0</td>
      <td>0.000529</td>
      <td>0.999257</td>
      <td>0.000153</td>
      <td>0.000020</td>
      <td>0.000021</td>
      <td>0.000019</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test.head()</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>method</th>
      <th>user_agent</th>
      <th>url</th>
      <th>refer</th>
      <th>body</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>GET</td>
      <td>Mozilla/5.0 (Windows NT 10.0; Win64; x64) Appl...</td>
      <td>/demo/aisec/upload.php?act='%7C%7C(select+1+fr...</td>
      <td>http://demo.aisec.cn/demo/aisec/upload.php?t=0...</td>
      <td>GET /demo/aisec/upload.php?act='%7C%7C(select+...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2102J2SC ...</td>
      <td>/livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=1&amp;openudid=5f...</td>
      <td>NaN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=1&amp;openudi...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>GET</td>
      <td>Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/2...</td>
      <td>/create_user/?username=%3Cscript%3Ealert(docum...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>GET</td>
      <td>NaN</td>
      <td>/mmsns/WeDwicXmkOl4kjKsBycicI0H3q41r6syFFvu46h...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>PUT</td>
      <td>Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/2...</td>
      <td>/naizau.jsp/</td>
      <td>NaN</td>
      <td>GET /login HTTP/1.1 Host: 111.160.211.18:8088 ...</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train.isnull().<span class="built_in">sum</span>()</span><br></pre></td></tr></table></figure>




<pre><code>id            0
method        0
user_agent    0
url           0
refer         0
body          0
label         0
text          0
fold          0
0             0
1             0
2             0
3             0
4             0
5             0
dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train.columns</span><br></pre></td></tr></table></figure>




<pre><code>Index([&#39;id&#39;, &#39;method&#39;, &#39;user_agent&#39;, &#39;url&#39;, &#39;refer&#39;, &#39;body&#39;, &#39;label&#39;, &#39;text&#39;,
       &#39;fold&#39;, &#39;0&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;, &#39;4&#39;, &#39;5&#39;],
      dtype=&#39;object&#39;)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">test[[<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>]]=prob</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># test[&#x27;label&#x27;]=pd.read_csv(&#x27;models/v4/lgb.csv&#x27;)[&#x27;predict&#x27;]</span></span><br><span class="line">train=train.drop(<span class="string">&#x27;text&#x27;</span>,axis=<span class="number">1</span>)</span><br><span class="line">train=train.drop(<span class="string">&#x27;fold&#x27;</span>,axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">train=train[[<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;method&#x27;</span>, <span class="string">&#x27;user_agent&#x27;</span>, <span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;refer&#x27;</span>, <span class="string">&#x27;body&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;label&#x27;</span>]]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;train.shape&quot;</span>,train.shape)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;test.shape&quot;</span>,test.shape)</span><br></pre></td></tr></table></figure>

<pre><code>train.shape (33037, 13)
test.shape (4000, 12)
</code></pre>
<h1 id="数据分析"><a href="#数据分析" class="headerlink" title="数据分析"></a>数据分析</h1><p>赛题训练集分为6种不同标签，共计约3.5万条数据。训练数据集字段内容主要包括：<br>●　lable：攻击类型编号<br>●　其他：HTTP协议内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看训练集的字段</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train.columns</span><br></pre></td></tr></table></figure>




<pre><code>Index([&#39;id&#39;, &#39;method&#39;, &#39;user_agent&#39;, &#39;url&#39;, &#39;refer&#39;, &#39;body&#39;, &#39;0&#39;, &#39;1&#39;, &#39;2&#39;,
       &#39;3&#39;, &#39;4&#39;, &#39;5&#39;, &#39;label&#39;],
      dtype=&#39;object&#39;)
</code></pre>
<p>‘lable’看着很别扭，重新rename一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train=train.rename(columns=&#123;<span class="string">&#x27;lable&#x27;</span>:<span class="string">&#x27;label&#x27;</span>&#125;)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">train.dtypes</span><br></pre></td></tr></table></figure>




<pre><code>id              int64
method         object
user_agent     object
url            object
refer          object
body           object
0             float32
1             float32
2             float32
3             float32
4             float32
5             float32
label           int64
dtype: object
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 标签个数统计</span></span><br><span class="line">train[<span class="string">&#x27;label&#x27;</span>].value_counts()</span><br></pre></td></tr></table></figure>




<pre><code>1    14038
2     9939
0     6489
3     1215
4      697
5      659
Name: label, dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">train[<span class="string">&#x27;label&#x27;</span>].value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://s2.loli.net/2022/12/05/2x7AWXbvuoigw8n.png" alt="Snipaste_2022-12-05_12-13-30.png"></p>
<p>​    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data=pd.concat([train,test],axis=<span class="number">0</span>).reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">data.nunique()</span><br></pre></td></tr></table></figure>




<pre><code>id            19497
method           21
user_agent     1087
url           36613
refer           941
body          22380
0             35915
1             31618
2             36061
3             36961
4             36965
5             36959
label             6
dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 缺失值处理：</span></span><br><span class="line">data[<span class="string">&#x27;user_agent&#x27;</span>]=data[<span class="string">&#x27;user_agent&#x27;</span>].fillna(<span class="string">&#x27;NAN&#x27;</span>)</span><br><span class="line">data[<span class="string">&#x27;refer&#x27;</span>]=data[<span class="string">&#x27;refer&#x27;</span>].fillna(<span class="string">&#x27;NAN&#x27;</span>)</span><br><span class="line">data[<span class="string">&#x27;body&#x27;</span>]=data[<span class="string">&#x27;body&#x27;</span>].fillna(<span class="string">&#x27;NAN&#x27;</span>)</span><br><span class="line">data[<span class="string">&#x27;url&#x27;</span>]=data[<span class="string">&#x27;url&#x27;</span>].fillna(<span class="string">&#x27;NAN&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取user_agent特征</span></span><br><span class="line">ua_cols=[<span class="string">&#x27;browser_family&#x27;</span>, <span class="string">&#x27;os_family&#x27;</span>, <span class="string">&#x27;device_family&#x27;</span>,<span class="string">&#x27;device_brand&#x27;</span>,<span class="string">&#x27;device_model&#x27;</span>]</span><br><span class="line">data[ua_cols] = data.apply(get_ua, axis=<span class="number">1</span>, result_type=<span class="string">&quot;expand&quot;</span>)</span><br><span class="line">data.head()</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>method</th>
      <th>user_agent</th>
      <th>url</th>
      <th>refer</th>
      <th>body</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>label</th>
      <th>browser_family</th>
      <th>os_family</th>
      <th>device_family</th>
      <th>device_brand</th>
      <th>device_model</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13429</td>
      <td>GET</td>
      <td>'||(select 1 from (select pg_sleep(8))x)||'</td>
      <td>/kelev/scripts/?C=M%3BO%3DA</td>
      <td>NAN</td>
      <td>GET /kelev/scripts/?C=M%3BO%3DA HTTP/1.1 Accep...</td>
      <td>0.000238</td>
      <td>0.999110</td>
      <td>0.000445</td>
      <td>0.000058</td>
      <td>0.000040</td>
      <td>0.000110</td>
      <td>1.0</td>
      <td>Other</td>
      <td>Other</td>
      <td>Other</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18125</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2102K1C B...</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>NAN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;...</td>
      <td>0.006598</td>
      <td>0.992451</td>
      <td>0.000763</td>
      <td>0.000086</td>
      <td>0.000067</td>
      <td>0.000035</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>M2102K1C</td>
      <td>Generic_Android</td>
      <td>M2102K1C</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14538</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2011K2C B...</td>
      <td>/livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudid=d2...</td>
      <td>NAN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudi...</td>
      <td>0.000783</td>
      <td>0.999017</td>
      <td>0.000138</td>
      <td>0.000031</td>
      <td>0.000017</td>
      <td>0.000013</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>M2011K2C</td>
      <td>Generic_Android</td>
      <td>M2011K2C</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7127</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 10; MI 9 MIUI/...</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>NAN</td>
      <td>NAN</td>
      <td>0.007603</td>
      <td>0.991491</td>
      <td>0.000725</td>
      <td>0.000087</td>
      <td>0.000062</td>
      <td>0.000033</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>XiaoMi MI 9</td>
      <td>XiaoMi</td>
      <td>MI 9</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 10; ELS-AN00 B...</td>
      <td>/livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid=&amp;ty...</td>
      <td>NAN</td>
      <td>GET /livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid...</td>
      <td>0.000529</td>
      <td>0.999257</td>
      <td>0.000153</td>
      <td>0.000020</td>
      <td>0.000021</td>
      <td>0.000019</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>ELS-AN00</td>
      <td>Huawei</td>
      <td>ELS-AN00</td>
    </tr>
  </tbody>
</table>
</div>



<h1 id="基础特征"><a href="#基础特征" class="headerlink" title="基础特征"></a>基础特征</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> urllib</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&#x27;user_agent_len&#x27;</span>]=data[<span class="string">&#x27;user_agent&#x27;</span>].apply(<span class="keyword">lambda</span> x:<span class="built_in">len</span>(x))</span><br><span class="line">data[<span class="string">&#x27;url_len&#x27;</span>]=data[<span class="string">&#x27;url&#x27;</span>].apply(<span class="keyword">lambda</span> x:<span class="built_in">len</span>(x))</span><br><span class="line">data[<span class="string">&#x27;refer_len&#x27;</span>]=data[<span class="string">&#x27;refer&#x27;</span>].apply(<span class="keyword">lambda</span> x:<span class="built_in">len</span>(x))</span><br><span class="line">data[<span class="string">&#x27;body_len&#x27;</span>]=data[<span class="string">&#x27;body&#x27;</span>].apply(<span class="keyword">lambda</span> x:<span class="built_in">len</span>(x))</span><br><span class="line">data[<span class="string">&#x27;body_user_agent_len_diff&#x27;</span>]=data[<span class="string">&#x27;body_len&#x27;</span>]-data[<span class="string">&#x27;user_agent_len&#x27;</span>]</span><br><span class="line">data[<span class="string">&#x27;body_url_len_diff&#x27;</span>]=data[<span class="string">&#x27;body_len&#x27;</span>]-data[<span class="string">&#x27;url_len&#x27;</span>]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将user_agent列进行tfidf特征提取，再SVD变成16维度</span></span><br><span class="line">texts=data[<span class="string">&#x27;user_agent&#x27;</span>].values.tolist()</span><br><span class="line"></span><br><span class="line">n_components = <span class="number">16</span>      <span class="comment"># 期望维数 </span></span><br><span class="line">tf = TfidfVectorizer(min_df= <span class="number">1</span>, max_df=<span class="number">0.5</span>,analyzer = <span class="string">&#x27;char_wb&#x27;</span>, ngram_range = (<span class="number">1</span>,<span class="number">3</span>))     <span class="comment"># ngram_range = (2,5)</span></span><br><span class="line">X = tf.fit_transform(texts)</span><br><span class="line">svd = TruncatedSVD(n_components=n_components,</span><br><span class="line">                   random_state=<span class="number">42</span>)</span><br><span class="line">X_svd = svd.fit_transform(X)</span><br><span class="line">df_tfidf = pd.DataFrame(X_svd)</span><br><span class="line">df_tfidf.columns = [<span class="string">f&#x27;user_agent_name_tfidf_<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_components)]</span><br><span class="line">data=pd.concat([data,df_tfidf],axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">texts=data[<span class="string">&#x27;url&#x27;</span>].values.tolist()</span><br><span class="line"></span><br><span class="line">n_components = <span class="number">16</span></span><br><span class="line">tf = TfidfVectorizer(min_df= <span class="number">1</span>, max_df=<span class="number">0.5</span>,analyzer = <span class="string">&#x27;char_wb&#x27;</span>, ngram_range = (<span class="number">1</span>,<span class="number">3</span>))</span><br><span class="line">X = tf.fit_transform(texts)</span><br><span class="line">svd = TruncatedSVD(n_components=n_components,</span><br><span class="line">                   random_state=<span class="number">42</span>)</span><br><span class="line">X_svd = svd.fit_transform(X)</span><br><span class="line">df_tfidf = pd.DataFrame(X_svd)</span><br><span class="line">df_tfidf.columns = [<span class="string">f&#x27;url_name_tfidf_<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_components)]</span><br><span class="line">data=pd.concat([data,df_tfidf],axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># texts=data[&#x27;refer&#x27;].values.tolist()</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># n_components = 16</span></span><br><span class="line"><span class="comment"># tf = TfidfVectorizer(min_df= 1, max_df=0.5,analyzer = &#x27;char_wb&#x27;, ngram_range = (1,3))</span></span><br><span class="line"><span class="comment"># X = tf.fit_transform(texts)</span></span><br><span class="line"><span class="comment"># svd = TruncatedSVD(n_components=n_components,</span></span><br><span class="line"><span class="comment">#                    random_state=42)</span></span><br><span class="line"><span class="comment"># X_svd = svd.fit_transform(X)</span></span><br><span class="line"><span class="comment"># df_tfidf = pd.DataFrame(X_svd)</span></span><br><span class="line"><span class="comment"># df_tfidf.columns = [f&#x27;refer_tfidf_&#123;i&#125;&#x27; for i in range(n_components)]</span></span><br><span class="line"><span class="comment"># data=pd.concat([data,df_tfidf],axis=1)</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">texts=data[<span class="string">&#x27;body&#x27;</span>].values.tolist()</span><br><span class="line"></span><br><span class="line">n_components = <span class="number">32</span></span><br><span class="line">tf = TfidfVectorizer(min_df= <span class="number">1</span>, max_df=<span class="number">0.5</span>,analyzer = <span class="string">&#x27;char_wb&#x27;</span>, ngram_range = (<span class="number">1</span>,<span class="number">3</span>))</span><br><span class="line">X = tf.fit_transform(texts)</span><br><span class="line">svd = TruncatedSVD(n_components=n_components,</span><br><span class="line">                   random_state=<span class="number">42</span>)</span><br><span class="line">X_svd = svd.fit_transform(X)</span><br><span class="line">df_tfidf = pd.DataFrame(X_svd)</span><br><span class="line">df_tfidf.columns = [<span class="string">f&#x27;body_tfidf_<span class="subst">&#123;i&#125;</span>&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_components)]</span><br><span class="line">data=pd.concat([data,df_tfidf],axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> [<span class="string">&#x27;method&#x27;</span>, <span class="string">&#x27;url&#x27;</span>,<span class="string">&#x27;refer&#x27;</span>, <span class="string">&#x27;body&#x27;</span>,<span class="string">&#x27;browser_family&#x27;</span>,<span class="string">&#x27;os_family&#x27;</span>,<span class="string">&#x27;device_family&#x27;</span>,<span class="string">&#x27;device_brand&#x27;</span>,<span class="string">&#x27;device_model&#x27;</span>]:    <span class="comment"># refer</span></span><br><span class="line">    data[<span class="string">f&#x27;id_<span class="subst">&#123;f&#125;</span>_nunique&#x27;</span>] = data.groupby([<span class="string">&#x27;id&#x27;</span>])[f].transform(<span class="string">&#x27;nunique&#x27;</span>)</span><br><span class="line">    data[<span class="string">f&#x27;id_<span class="subst">&#123;f&#125;</span>_count&#x27;</span>] = data.groupby([<span class="string">&#x27;id&#x27;</span>])[f].transform(<span class="string">&#x27;count&#x27;</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.split(<span class="string">&#x27;[=&amp;]&#x27;</span>, urlparse(data[<span class="string">&#x27;url&#x27;</span>][<span class="number">0</span>])[<span class="number">4</span>])</span><br></pre></td></tr></table></figure>




<pre><code>[&#39;C&#39;, &#39;M%3BO%3DA&#39;]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_url_query</span>(<span class="params">s</span>):</span><br><span class="line">    li = re.split(<span class="string">&#x27;[=&amp;]&#x27;</span>, urlparse(s)[<span class="number">4</span>])</span><br><span class="line">    <span class="keyword">return</span> [li[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(li)) <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_max_str_length</span>(<span class="params">x</span>):</span><br><span class="line">    max_ = <span class="number">0</span></span><br><span class="line">    li = [<span class="built_in">len</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> x]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">max</span>(li) <span class="keyword">if</span> <span class="built_in">len</span>(li) &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_str_length_std</span>(<span class="params">x</span>):</span><br><span class="line">    max_ = <span class="number">0</span></span><br><span class="line">    li = [<span class="built_in">len</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> x]</span><br><span class="line">    <span class="keyword">return</span> np.std(li) <span class="keyword">if</span> <span class="built_in">len</span>(li) &gt; <span class="number">0</span> <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;url_unquote&#x27;</span>] = data[<span class="string">&#x27;url&#x27;</span>].apply(unquote)</span><br><span class="line">data[<span class="string">&#x27;url_query&#x27;</span>] = data[<span class="string">&#x27;url_unquote&#x27;</span>].apply(<span class="keyword">lambda</span> x: get_url_query(x))</span><br><span class="line">data[<span class="string">&#x27;url_query_num&#x27;</span>] = data[<span class="string">&#x27;url_query&#x27;</span>].apply(<span class="built_in">len</span>)</span><br><span class="line">data[<span class="string">&#x27;url_query_max_len&#x27;</span>] = data[<span class="string">&#x27;url_query&#x27;</span>].apply(find_max_str_length)</span><br><span class="line">data[<span class="string">&#x27;url_query_len_std&#x27;</span>] = data[<span class="string">&#x27;url_query&#x27;</span>].apply(find_str_length_std)</span><br><span class="line">data[<span class="string">&#x27;url&#x27;</span>].apply(unquote)</span><br></pre></td></tr></table></figure>




<pre><code>0                                  /kelev/scripts/?C=M;O=A
1        /livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...
2        /livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudid=d2...
3        /livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...
4        /livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid=&amp;ty...
                               ...                        
37032    /livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=1&amp;openudid=64...
37033                                          /runtime.js
37034                                     /query?493521812
37035              /stats.php?rand=JtmT4wBtrpNy5RJnNX9wCUo
37036    /api/gateway.do?method=qihoo.sdk.user.mobile.l...
Name: url, Length: 37037, dtype: object
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data.head()</span><br></pre></td></tr></table></figure>




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }


<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>method</th>
      <th>user_agent</th>
      <th>url</th>
      <th>refer</th>
      <th>body</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>label</th>
      <th>browser_family</th>
      <th>os_family</th>
      <th>device_family</th>
      <th>device_brand</th>
      <th>device_model</th>
      <th>user_agent_len</th>
      <th>url_len</th>
      <th>refer_len</th>
      <th>body_len</th>
      <th>body_user_agent_len_diff</th>
      <th>body_url_len_diff</th>
      <th>user_agent_name_tfidf_0</th>
      <th>user_agent_name_tfidf_1</th>
      <th>user_agent_name_tfidf_2</th>
      <th>user_agent_name_tfidf_3</th>
      <th>user_agent_name_tfidf_4</th>
      <th>user_agent_name_tfidf_5</th>
      <th>user_agent_name_tfidf_6</th>
      <th>user_agent_name_tfidf_7</th>
      <th>user_agent_name_tfidf_8</th>
      <th>user_agent_name_tfidf_9</th>
      <th>user_agent_name_tfidf_10</th>
      <th>user_agent_name_tfidf_11</th>
      <th>user_agent_name_tfidf_12</th>
      <th>user_agent_name_tfidf_13</th>
      <th>user_agent_name_tfidf_14</th>
      <th>user_agent_name_tfidf_15</th>
      <th>url_name_tfidf_0</th>
      <th>url_name_tfidf_1</th>
      <th>url_name_tfidf_2</th>
      <th>url_name_tfidf_3</th>
      <th>url_name_tfidf_4</th>
      <th>url_name_tfidf_5</th>
      <th>url_name_tfidf_6</th>
      <th>url_name_tfidf_7</th>
      <th>url_name_tfidf_8</th>
      <th>url_name_tfidf_9</th>
      <th>url_name_tfidf_10</th>
      <th>url_name_tfidf_11</th>
      <th>url_name_tfidf_12</th>
      <th>url_name_tfidf_13</th>
      <th>url_name_tfidf_14</th>
      <th>url_name_tfidf_15</th>
      <th>body_tfidf_0</th>
      <th>body_tfidf_1</th>
      <th>body_tfidf_2</th>
      <th>body_tfidf_3</th>
      <th>body_tfidf_4</th>
      <th>body_tfidf_5</th>
      <th>body_tfidf_6</th>
      <th>body_tfidf_7</th>
      <th>body_tfidf_8</th>
      <th>body_tfidf_9</th>
      <th>body_tfidf_10</th>
      <th>body_tfidf_11</th>
      <th>body_tfidf_12</th>
      <th>body_tfidf_13</th>
      <th>body_tfidf_14</th>
      <th>body_tfidf_15</th>
      <th>body_tfidf_16</th>
      <th>body_tfidf_17</th>
      <th>body_tfidf_18</th>
      <th>body_tfidf_19</th>
      <th>body_tfidf_20</th>
      <th>body_tfidf_21</th>
      <th>body_tfidf_22</th>
      <th>body_tfidf_23</th>
      <th>body_tfidf_24</th>
      <th>body_tfidf_25</th>
      <th>body_tfidf_26</th>
      <th>body_tfidf_27</th>
      <th>body_tfidf_28</th>
      <th>body_tfidf_29</th>
      <th>body_tfidf_30</th>
      <th>body_tfidf_31</th>
      <th>id_method_nunique</th>
      <th>id_method_count</th>
      <th>id_url_nunique</th>
      <th>id_url_count</th>
      <th>id_refer_nunique</th>
      <th>id_refer_count</th>
      <th>id_body_nunique</th>
      <th>id_body_count</th>
      <th>id_browser_family_nunique</th>
      <th>id_browser_family_count</th>
      <th>id_os_family_nunique</th>
      <th>id_os_family_count</th>
      <th>id_device_family_nunique</th>
      <th>id_device_family_count</th>
      <th>id_device_brand_nunique</th>
      <th>id_device_brand_count</th>
      <th>id_device_model_nunique</th>
      <th>id_device_model_count</th>
      <th>url_unquote</th>
      <th>url_query</th>
      <th>url_query_num</th>
      <th>url_query_max_len</th>
      <th>url_query_len_std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13429</td>
      <td>GET</td>
      <td>'||(select 1 from (select pg_sleep(8))x)||'</td>
      <td>/kelev/scripts/?C=M%3BO%3DA</td>
      <td>NAN</td>
      <td>GET /kelev/scripts/?C=M%3BO%3DA HTTP/1.1 Accep...</td>
      <td>0.000238</td>
      <td>0.999110</td>
      <td>0.000445</td>
      <td>0.000058</td>
      <td>0.000040</td>
      <td>0.000110</td>
      <td>1.0</td>
      <td>Other</td>
      <td>Other</td>
      <td>Other</td>
      <td>None</td>
      <td>None</td>
      <td>43</td>
      <td>27</td>
      <td>3</td>
      <td>212</td>
      <td>169</td>
      <td>185</td>
      <td>0.010070</td>
      <td>0.009456</td>
      <td>0.001205</td>
      <td>0.003217</td>
      <td>0.021082</td>
      <td>0.000999</td>
      <td>-0.000847</td>
      <td>-0.002107</td>
      <td>0.008443</td>
      <td>0.002747</td>
      <td>0.023997</td>
      <td>-0.003526</td>
      <td>-0.001894</td>
      <td>-0.013000</td>
      <td>-0.005918</td>
      <td>0.009153</td>
      <td>0.066298</td>
      <td>0.059683</td>
      <td>-0.057310</td>
      <td>-0.006595</td>
      <td>-0.001159</td>
      <td>0.094755</td>
      <td>-0.021858</td>
      <td>0.023071</td>
      <td>-0.001968</td>
      <td>0.043890</td>
      <td>0.022147</td>
      <td>-0.006037</td>
      <td>-0.005375</td>
      <td>0.014239</td>
      <td>0.077494</td>
      <td>0.081818</td>
      <td>0.000054</td>
      <td>0.115960</td>
      <td>0.105404</td>
      <td>-0.027789</td>
      <td>-0.002577</td>
      <td>0.064009</td>
      <td>-0.039324</td>
      <td>0.006577</td>
      <td>0.023000</td>
      <td>-0.064038</td>
      <td>0.021134</td>
      <td>-0.058787</td>
      <td>0.011353</td>
      <td>0.066560</td>
      <td>0.010658</td>
      <td>0.189591</td>
      <td>-0.067039</td>
      <td>-0.116538</td>
      <td>-0.014128</td>
      <td>-0.029329</td>
      <td>0.047018</td>
      <td>-0.023777</td>
      <td>-0.035825</td>
      <td>0.005829</td>
      <td>0.013030</td>
      <td>-0.022777</td>
      <td>-0.007482</td>
      <td>0.039357</td>
      <td>0.046385</td>
      <td>-0.007902</td>
      <td>-0.029089</td>
      <td>-0.051989</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>/kelev/scripts/?C=M;O=A</td>
      <td>[M;O]</td>
      <td>1</td>
      <td>3</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>18125</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2102K1C B...</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>NAN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;...</td>
      <td>0.006598</td>
      <td>0.992451</td>
      <td>0.000763</td>
      <td>0.000086</td>
      <td>0.000067</td>
      <td>0.000035</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>M2102K1C</td>
      <td>Generic_Android</td>
      <td>M2102K1C</td>
      <td>67</td>
      <td>1747</td>
      <td>3</td>
      <td>2016</td>
      <td>1949</td>
      <td>269</td>
      <td>0.035096</td>
      <td>0.120188</td>
      <td>0.270092</td>
      <td>0.655747</td>
      <td>-0.042591</td>
      <td>-0.024738</td>
      <td>-0.019824</td>
      <td>-0.000642</td>
      <td>-0.015951</td>
      <td>-0.183311</td>
      <td>-0.026321</td>
      <td>-0.061993</td>
      <td>-0.018288</td>
      <td>0.027496</td>
      <td>-0.012776</td>
      <td>-0.002250</td>
      <td>0.617250</td>
      <td>-0.130247</td>
      <td>0.079094</td>
      <td>-0.023195</td>
      <td>0.003702</td>
      <td>-0.030486</td>
      <td>-0.013201</td>
      <td>-0.021136</td>
      <td>0.012303</td>
      <td>-0.006278</td>
      <td>-0.023727</td>
      <td>-0.003599</td>
      <td>0.027036</td>
      <td>0.006405</td>
      <td>-0.005268</td>
      <td>0.010234</td>
      <td>0.000132</td>
      <td>0.530101</td>
      <td>-0.277845</td>
      <td>0.022171</td>
      <td>-0.069403</td>
      <td>-0.062703</td>
      <td>-0.006813</td>
      <td>0.001156</td>
      <td>-0.028995</td>
      <td>-0.009364</td>
      <td>-0.013567</td>
      <td>0.015499</td>
      <td>-0.009968</td>
      <td>-0.032960</td>
      <td>-0.000036</td>
      <td>-0.008127</td>
      <td>-0.000813</td>
      <td>0.001447</td>
      <td>0.009261</td>
      <td>-0.017541</td>
      <td>-0.000682</td>
      <td>-0.003697</td>
      <td>0.007340</td>
      <td>-0.010968</td>
      <td>0.008710</td>
      <td>-0.067023</td>
      <td>-0.014870</td>
      <td>-0.024112</td>
      <td>0.011792</td>
      <td>0.004538</td>
      <td>0.014397</td>
      <td>-0.003550</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>[WL_WK, , web, 0, 1, 210810, 116, 1, 8, fa0d30...</td>
      <td>23</td>
      <td>1324</td>
      <td>268.709026</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14538</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 11; M2011K2C B...</td>
      <td>/livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudid=d2...</td>
      <td>NAN</td>
      <td>GET /livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudi...</td>
      <td>0.000783</td>
      <td>0.999017</td>
      <td>0.000138</td>
      <td>0.000031</td>
      <td>0.000017</td>
      <td>0.000013</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>M2011K2C</td>
      <td>Generic_Android</td>
      <td>M2011K2C</td>
      <td>67</td>
      <td>1688</td>
      <td>3</td>
      <td>1986</td>
      <td>1919</td>
      <td>298</td>
      <td>0.034866</td>
      <td>0.170330</td>
      <td>0.292857</td>
      <td>0.713273</td>
      <td>-0.047369</td>
      <td>-0.025480</td>
      <td>-0.014846</td>
      <td>-0.002015</td>
      <td>-0.095211</td>
      <td>-0.199969</td>
      <td>0.001352</td>
      <td>0.004859</td>
      <td>0.026900</td>
      <td>-0.000053</td>
      <td>-0.045812</td>
      <td>-0.003042</td>
      <td>0.662307</td>
      <td>-0.134895</td>
      <td>0.074788</td>
      <td>-0.033836</td>
      <td>0.004867</td>
      <td>-0.012766</td>
      <td>-0.014195</td>
      <td>-0.019396</td>
      <td>0.016613</td>
      <td>-0.006143</td>
      <td>-0.018700</td>
      <td>-0.012640</td>
      <td>0.030395</td>
      <td>0.004169</td>
      <td>-0.005899</td>
      <td>0.005060</td>
      <td>0.000137</td>
      <td>0.557311</td>
      <td>-0.298627</td>
      <td>0.021799</td>
      <td>-0.072395</td>
      <td>-0.035369</td>
      <td>-0.009561</td>
      <td>-0.020158</td>
      <td>-0.030540</td>
      <td>-0.019107</td>
      <td>-0.011824</td>
      <td>0.016220</td>
      <td>-0.010370</td>
      <td>-0.021592</td>
      <td>0.002470</td>
      <td>0.001666</td>
      <td>-0.004027</td>
      <td>-0.000666</td>
      <td>0.012006</td>
      <td>-0.009133</td>
      <td>-0.007882</td>
      <td>-0.001795</td>
      <td>-0.003188</td>
      <td>-0.015516</td>
      <td>0.010797</td>
      <td>-0.083144</td>
      <td>-0.021120</td>
      <td>-0.029922</td>
      <td>0.020777</td>
      <td>0.001687</td>
      <td>0.006579</td>
      <td>-0.001808</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>/livemsg?ad_type=WL_WK&amp;ty=web&amp;pu=0&amp;openudid=d2...</td>
      <td>[WL_WK, web, 0, d24c93f6c8de719a00f1676f3a9a53...</td>
      <td>29</td>
      <td>1154</td>
      <td>209.374211</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7127</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 10; MI 9 MIUI/...</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>NAN</td>
      <td>NAN</td>
      <td>0.007603</td>
      <td>0.991491</td>
      <td>0.000725</td>
      <td>0.000087</td>
      <td>0.000062</td>
      <td>0.000033</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>XiaoMi MI 9</td>
      <td>XiaoMi</td>
      <td>MI 9</td>
      <td>64</td>
      <td>1613</td>
      <td>3</td>
      <td>3</td>
      <td>-61</td>
      <td>-1610</td>
      <td>0.038503</td>
      <td>0.058521</td>
      <td>0.184916</td>
      <td>0.434441</td>
      <td>0.026507</td>
      <td>-0.024867</td>
      <td>-0.016191</td>
      <td>0.021308</td>
      <td>0.058906</td>
      <td>0.048677</td>
      <td>-0.015773</td>
      <td>-0.017188</td>
      <td>0.012508</td>
      <td>0.026593</td>
      <td>0.009872</td>
      <td>0.001220</td>
      <td>0.621003</td>
      <td>-0.119104</td>
      <td>0.071898</td>
      <td>-0.014246</td>
      <td>-0.005748</td>
      <td>-0.025066</td>
      <td>-0.015300</td>
      <td>-0.006643</td>
      <td>0.011277</td>
      <td>-0.011099</td>
      <td>-0.026949</td>
      <td>-0.013011</td>
      <td>0.027294</td>
      <td>0.006678</td>
      <td>0.006156</td>
      <td>0.004784</td>
      <td>1.000000</td>
      <td>-0.000356</td>
      <td>-0.000224</td>
      <td>-0.000019</td>
      <td>0.000078</td>
      <td>0.000016</td>
      <td>-0.000132</td>
      <td>-0.000012</td>
      <td>-0.000029</td>
      <td>0.000011</td>
      <td>-0.000044</td>
      <td>-0.000041</td>
      <td>-0.000041</td>
      <td>0.000027</td>
      <td>-0.000017</td>
      <td>-0.000027</td>
      <td>-0.000017</td>
      <td>-0.000096</td>
      <td>0.000005</td>
      <td>0.000026</td>
      <td>0.000013</td>
      <td>0.000016</td>
      <td>-0.000005</td>
      <td>-0.000005</td>
      <td>0.000015</td>
      <td>-0.000004</td>
      <td>0.000011</td>
      <td>0.000021</td>
      <td>-0.000004</td>
      <td>0.000045</td>
      <td>0.000019</td>
      <td>-0.000019</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>1</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>/livemsg?ad_type=WL_WK&amp;oadid=&amp;ty=web&amp;pu=0&amp;adap...</td>
      <td>[WL_WK, , web, 0, 1, 201209, 116, 1, 8, bbe035...</td>
      <td>24</td>
      <td>1186</td>
      <td>235.820461</td>
    </tr>
    <tr>
      <th>4</th>
      <td>7</td>
      <td>GET</td>
      <td>Dalvik/2.1.0 (Linux; U; Android 10; ELS-AN00 B...</td>
      <td>/livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid=&amp;ty...</td>
      <td>NAN</td>
      <td>GET /livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid...</td>
      <td>0.000529</td>
      <td>0.999257</td>
      <td>0.000153</td>
      <td>0.000020</td>
      <td>0.000021</td>
      <td>0.000019</td>
      <td>1.0</td>
      <td>Android</td>
      <td>Android</td>
      <td>ELS-AN00</td>
      <td>Huawei</td>
      <td>ELS-AN00</td>
      <td>66</td>
      <td>1467</td>
      <td>3</td>
      <td>1704</td>
      <td>1638</td>
      <td>237</td>
      <td>0.023016</td>
      <td>0.076053</td>
      <td>0.211935</td>
      <td>0.431614</td>
      <td>-0.013015</td>
      <td>-0.028123</td>
      <td>0.016032</td>
      <td>-0.039645</td>
      <td>0.129501</td>
      <td>0.388460</td>
      <td>-0.012173</td>
      <td>-0.016553</td>
      <td>-0.012854</td>
      <td>-0.049835</td>
      <td>-0.037182</td>
      <td>-0.024569</td>
      <td>0.615644</td>
      <td>-0.116622</td>
      <td>0.066164</td>
      <td>-0.019455</td>
      <td>-0.007366</td>
      <td>-0.022974</td>
      <td>-0.016564</td>
      <td>-0.006819</td>
      <td>-0.000959</td>
      <td>-0.011903</td>
      <td>-0.022060</td>
      <td>-0.011351</td>
      <td>0.002437</td>
      <td>-0.008505</td>
      <td>-0.008668</td>
      <td>-0.004333</td>
      <td>0.000129</td>
      <td>0.535128</td>
      <td>-0.294560</td>
      <td>0.024614</td>
      <td>-0.084538</td>
      <td>-0.049889</td>
      <td>-0.019040</td>
      <td>-0.000086</td>
      <td>-0.029467</td>
      <td>-0.026259</td>
      <td>-0.010166</td>
      <td>0.009809</td>
      <td>-0.017834</td>
      <td>-0.018439</td>
      <td>0.007596</td>
      <td>-0.017013</td>
      <td>-0.005269</td>
      <td>0.002957</td>
      <td>0.006733</td>
      <td>-0.010658</td>
      <td>-0.006394</td>
      <td>-0.005429</td>
      <td>0.011300</td>
      <td>-0.024379</td>
      <td>0.006489</td>
      <td>-0.061012</td>
      <td>-0.019155</td>
      <td>-0.021446</td>
      <td>0.021441</td>
      <td>-0.001876</td>
      <td>0.002968</td>
      <td>-0.005974</td>
      <td>2</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
      <td>/livemsg?sdtfrom=v5004&amp;ad_type=WL_WK&amp;oadid=&amp;ty...</td>
      <td>[v5004, WL_WK, , web, 0, 20220209V0BT5X00, 1, ...</td>
      <td>27</td>
      <td>972</td>
      <td>182.378599</td>
    </tr>
  </tbody>
</table>
</div>




<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_url_filetype</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> re.search(<span class="string">r&#x27;\.[a-z]+&#x27;</span>, x).group()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;__NaN__&#x27;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">data[<span class="string">&#x27;url_path&#x27;</span>] = data[<span class="string">&#x27;url_unquote&#x27;</span>].apply(<span class="keyword">lambda</span> x: urlparse(x)[<span class="number">2</span>])</span><br><span class="line">data[<span class="string">&#x27;url_filetype&#x27;</span>] = data[<span class="string">&#x27;url_path&#x27;</span>].apply(<span class="keyword">lambda</span> x: find_url_filetype(x))</span><br><span class="line"></span><br><span class="line">data[<span class="string">&#x27;url_path_len&#x27;</span>] = data[<span class="string">&#x27;url_path&#x27;</span>].apply(<span class="built_in">len</span>)</span><br><span class="line">data[<span class="string">&#x27;url_path_num&#x27;</span>] = data[<span class="string">&#x27;url_path&#x27;</span>].apply(<span class="keyword">lambda</span> x: <span class="built_in">len</span>(re.findall(<span class="string">&#x27;/&#x27;</span>,  x)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data[<span class="string">&#x27;ua_short&#x27;</span>] = data[<span class="string">&#x27;user_agent&#x27;</span>].apply(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">data[<span class="string">&#x27;ua_first&#x27;</span>] = data[<span class="string">&#x27;user_agent&#x27;</span>].apply(<span class="keyword">lambda</span> x: x.split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># def strs_contains(strs, keyword):</span></span><br><span class="line"><span class="comment">#     return True if re.search(keyword, strs, re.IGNORECASE) else False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_select&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;select&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_select_from&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;select.*from&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_union&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;union&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_where&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;where&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_struts2&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;struts2&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_alert&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;alert&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_sudo&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;sudo&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_etc_passwd&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;etc.*passwd&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_dot_dot&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;%2e%2e%2f&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_dot_dot2&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;\.\./&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_javascript&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;javascript&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_shell&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;shell&#x27;))</span></span><br><span class="line"><span class="comment"># data[&#x27;url_contains_java_lang&#x27;] = data[&#x27;url_unquote&#x27;].apply(lambda x: strs_contains(x, &#x27;java.lang&#x27;))</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> col <span class="keyword">in</span> tqdm([<span class="string">&#x27;method&#x27;</span>, <span class="string">&#x27;refer&#x27;</span>, <span class="string">&#x27;browser_family&#x27;</span>,<span class="string">&#x27;os_family&#x27;</span>,<span class="string">&#x27;device_family&#x27;</span>, <span class="string">&#x27;device_brand&#x27;</span>, <span class="string">&#x27;device_model&#x27;</span>,<span class="string">&#x27;url_filetype&#x27;</span>,<span class="string">&#x27;ua_short&#x27;</span>,<span class="string">&#x27;ua_first&#x27;</span>]):</span><br><span class="line">    le = LabelEncoder()</span><br><span class="line">    data[col] = le.fit_transform(data[col])</span><br></pre></td></tr></table></figure>

<pre><code>100%|██████████████████████████████████████████████████████████████████████████████████| 10/10 [00:00&lt;00:00, 82.97it/s]
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">len</span>(data.select_dtypes(include=[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;float&#x27;</span>]).columns.tolist())</span><br></pre></td></tr></table></figure>




<pre><code>109
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">col = data.select_dtypes(include=[<span class="string">&#x27;int&#x27;</span>,<span class="string">&#x27;float&#x27;</span>]).columns.tolist()</span><br><span class="line">data = data[col]</span><br><span class="line">feature_names = [i <span class="keyword">for</span> i <span class="keyword">in</span> col <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;label&#x27;</span>]]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">train = data[data[<span class="string">&#x27;label&#x27;</span>].notnull()].reset_index(drop = <span class="literal">True</span>)</span><br><span class="line">test = data[~data[<span class="string">&#x27;label&#x27;</span>].notnull()].reset_index(drop = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">x_train = train[feature_names]</span><br><span class="line">y_train = train[<span class="string">&#x27;label&#x27;</span>]</span><br><span class="line">x_test = test[feature_names]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x_train.shape</span><br></pre></td></tr></table></figure>




<pre><code>(33037, 107)
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lgb_model</span>(<span class="params">train, target, test, k</span>):</span><br><span class="line">    feats = [f <span class="keyword">for</span> f <span class="keyword">in</span> train.columns <span class="keyword">if</span> f <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;label&#x27;</span>,  <span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;url_count&#x27;</span>]]</span><br><span class="line">    <span class="comment">#     feats=import_cols</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Current num of features:&#x27;</span>, <span class="built_in">len</span>(feats))</span><br><span class="line"></span><br><span class="line">    oof_probs = np.zeros((train.shape[<span class="number">0</span>],<span class="number">6</span>))</span><br><span class="line">    output_preds = <span class="number">0</span></span><br><span class="line">    offline_score = []</span><br><span class="line">    feature_importance_df = pd.DataFrame()</span><br><span class="line">    parameters = &#123;</span><br><span class="line">        <span class="string">&#x27;learning_rate&#x27;</span>: <span class="number">0.03</span>,</span><br><span class="line">        <span class="string">&#x27;boosting_type&#x27;</span>: <span class="string">&#x27;gbdt&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;objective&#x27;</span>: <span class="string">&#x27;multiclass&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;metric&#x27;</span>: <span class="string">&#x27;multi_error&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;num_class&#x27;</span>: <span class="number">6</span>,</span><br><span class="line">        <span class="string">&#x27;num_leaves&#x27;</span>: <span class="number">31</span>,</span><br><span class="line">        <span class="string">&#x27;feature_fraction&#x27;</span>: <span class="number">0.6</span>,</span><br><span class="line">        <span class="string">&#x27;bagging_fraction&#x27;</span>: <span class="number">0.8</span>,</span><br><span class="line">        <span class="string">&#x27;min_data_in_leaf&#x27;</span>: <span class="number">15</span>,</span><br><span class="line">        <span class="string">&#x27;verbose&#x27;</span>: -<span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;nthread&#x27;</span>: -<span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;max_depth&#x27;</span>: <span class="number">7</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># parameters = &#123;</span></span><br><span class="line">    <span class="comment">#         &#x27;learning_rate&#x27;: 0.1,</span></span><br><span class="line">    <span class="comment">#         &#x27;metric&#x27;: &#x27;multiclass&#x27;,</span></span><br><span class="line">    <span class="comment">#         &#x27;objective&#x27;: &#x27;multiclass&#x27;,</span></span><br><span class="line">    <span class="comment">#         &#x27;num_classes&#x27;: 6,</span></span><br><span class="line">    <span class="comment">#         &#x27;feature_fraction&#x27;: 0.75,</span></span><br><span class="line">    <span class="comment">#         &#x27;bagging_fraction&#x27;: 0.75,</span></span><br><span class="line">    <span class="comment">#         &#x27;bagging_freq&#x27;: 2,</span></span><br><span class="line">    <span class="comment">#         &#x27;n_jobs&#x27;: -1,</span></span><br><span class="line">    <span class="comment">#         &#x27;seed&#x27;: 1029,</span></span><br><span class="line">    <span class="comment">#         &#x27;max_depth&#x27;: 10,</span></span><br><span class="line">    <span class="comment">#         &#x27;num_leaves&#x27;: 100,</span></span><br><span class="line">    <span class="comment">#         &#x27;lambda_l1&#x27;: 0.5,</span></span><br><span class="line">    <span class="comment">#         &#x27;lambda_l2&#x27;: 0.8,</span></span><br><span class="line">    <span class="comment">#         &#x27;verbose&#x27;: -1</span></span><br><span class="line">    <span class="comment">#     &#125;</span></span><br><span class="line"></span><br><span class="line">    seeds = [<span class="number">2020</span>]</span><br><span class="line">    <span class="keyword">for</span> seed <span class="keyword">in</span> seeds:</span><br><span class="line">        folds = StratifiedKFold(n_splits=k, shuffle=<span class="literal">True</span>, random_state=seed)</span><br><span class="line">        <span class="keyword">for</span> i, (train_index, test_index) <span class="keyword">in</span> <span class="built_in">enumerate</span>(folds.split(train, target)):</span><br><span class="line">            train_y, test_y = target.iloc[train_index], target.iloc[test_index]</span><br><span class="line">            train_X, test_X = train[feats].iloc[train_index, :], train[feats].iloc[test_index, :]</span><br><span class="line"></span><br><span class="line">            dtrain = lgb.Dataset(train_X,</span><br><span class="line">                                 label=train_y)</span><br><span class="line">            dval = lgb.Dataset(test_X,</span><br><span class="line">                               label=test_y)</span><br><span class="line">            lgb_model = lgb.train(</span><br><span class="line">                parameters,</span><br><span class="line">                dtrain,</span><br><span class="line">                num_boost_round=<span class="number">8000</span>,</span><br><span class="line">                valid_sets=[dval],</span><br><span class="line">                <span class="comment"># feval = evalerror,</span></span><br><span class="line">                callbacks=[early_stopping(<span class="number">100</span>), log_evaluation(<span class="number">100</span>)],</span><br><span class="line">            )</span><br><span class="line">            oof_probs[test_index] = lgb_model.predict(test_X[feats], num_iteration=lgb_model.best_iteration) / <span class="built_in">len</span>(</span><br><span class="line">                seeds)</span><br><span class="line">            offline_score.append(lgb_model.best_score[<span class="string">&#x27;valid_0&#x27;</span>][<span class="string">&#x27;multi_error&#x27;</span>])</span><br><span class="line">            output_preds += lgb_model.predict(test[feats],</span><br><span class="line">                                              num_iteration=lgb_model.best_iteration) / folds.n_splits / <span class="built_in">len</span>(seeds)</span><br><span class="line">            <span class="built_in">print</span>(offline_score)</span><br><span class="line">            <span class="comment"># feature importance</span></span><br><span class="line">            fold_importance_df = pd.DataFrame()</span><br><span class="line">            fold_importance_df[<span class="string">&quot;feature&quot;</span>] = feats</span><br><span class="line">            fold_importance_df[<span class="string">&quot;importance&quot;</span>] = lgb_model.feature_importance(importance_type=<span class="string">&#x27;gain&#x27;</span>)</span><br><span class="line">            fold_importance_df[<span class="string">&quot;fold&quot;</span>] = i + <span class="number">1</span></span><br><span class="line">            feature_importance_df = pd.concat([feature_importance_df, fold_importance_df], axis=<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;OOF-MEAN-AUC:%.6f, OOF-STD-AUC:%.6f&#x27;</span> % (np.mean(offline_score), np.std(offline_score)))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;feature importance:&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(feature_importance_df.groupby([<span class="string">&#x27;feature&#x27;</span>])[<span class="string">&#x27;importance&#x27;</span>].mean().sort_values(ascending=<span class="literal">False</span>).head(<span class="number">50</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> output_preds, oof_probs, np.mean(offline_score), feature_importance_df</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># feature_names = list(</span></span><br><span class="line"><span class="comment">#     filter(</span></span><br><span class="line"><span class="comment">#         lambda x: x not in [&#x27;id&#x27;,&#x27;label&#x27;,&#x27;url&#x27;, &#x27;url_count&#x27;,&#x27;url_query&#x27;],</span></span><br><span class="line"><span class="comment">#         train.columns))</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;开始模型训练train&#x27;</span>)</span><br><span class="line">lgb_preds, lgb_oof, lgb_score, feature_importance_df = lgb_model(train=train[feature_names],</span><br><span class="line">                                                                 target=train[<span class="string">&#x27;label&#x27;</span>],</span><br><span class="line">                                                                 test=test[feature_names], k=<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<pre><code>开始模型训练train
Current num of features: 107
Training until validation scores don&#39;t improve for 100 rounds
[100]	valid_0&#39;s multi_error: 0.0145278
[200]	valid_0&#39;s multi_error: 0.0136199
[300]	valid_0&#39;s multi_error: 0.0134685
Early stopping, best iteration is:
[203]	valid_0&#39;s multi_error: 0.0133172
[0.013317191283292978]
Training until validation scores don&#39;t improve for 100 rounds
[100]	valid_0&#39;s multi_error: 0.0119552
Early stopping, best iteration is:
[63]	valid_0&#39;s multi_error: 0.0116525
[0.013317191283292978, 0.011652542372881356]
Training until validation scores don&#39;t improve for 100 rounds
[100]	valid_0&#39;s multi_error: 0.011503
Early stopping, best iteration is:
[92]	valid_0&#39;s multi_error: 0.011503
[0.013317191283292978, 0.011652542372881356, 0.011502951415165732]
Training until validation scores don&#39;t improve for 100 rounds
[100]	valid_0&#39;s multi_error: 0.011503
Early stopping, best iteration is:
[55]	valid_0&#39;s multi_error: 0.0107462
[0.013317191283292978, 0.011652542372881356, 0.011502951415165732, 0.010746178295746934]
Training until validation scores don&#39;t improve for 100 rounds
[100]	valid_0&#39;s multi_error: 0.011503
Early stopping, best iteration is:
[21]	valid_0&#39;s multi_error: 0.0112002
[0.013317191283292978, 0.011652542372881356, 0.011502951415165732, 0.010746178295746934, 0.011200242167398214]
OOF-MEAN-AUC:0.011684, OOF-STD-AUC:0.000873
feature importance:
feature
2                           222576.439984
1                           211736.666876
0                           147032.174178
4                           108800.598945
3                            86021.756831
browser_family               62270.501839
5                            39814.736140
body_tfidf_0                 27317.752312
body_tfidf_1                 23303.336642
url_name_tfidf_2             16427.787706
url_name_tfidf_14            15618.236285
url_name_tfidf_3             14344.577968
user_agent_len                9418.270741
body_user_agent_len_diff      9103.063841
user_agent_name_tfidf_2       8463.647873
url_query_max_len             6510.758108
user_agent_name_tfidf_5       4018.171339
body_tfidf_3                  3672.676081
body_tfidf_23                 3355.861338
user_agent_name_tfidf_4       3142.178290
url_name_tfidf_4              3127.492671
url_name_tfidf_13             2886.949569
url_name_tfidf_1              2849.448233
url_name_tfidf_5              2676.723486
user_agent_name_tfidf_7       2330.854639
user_agent_name_tfidf_14      2310.199494
refer_len                     2145.159362
user_agent_name_tfidf_3       2103.610035
body_tfidf_10                 1986.768004
url_name_tfidf_6              1866.483835
body_url_len_diff             1849.085455
body_tfidf_6                  1846.585181
body_len                      1821.060478
user_agent_name_tfidf_0       1743.131918
id_method_count               1659.460621
user_agent_name_tfidf_13      1627.554725
body_tfidf_5                  1539.584926
url_name_tfidf_8              1485.817275
url_name_tfidf_9              1449.335372
url_name_tfidf_12             1429.778973
url_name_tfidf_10             1413.196746
url_name_tfidf_11             1296.268733
user_agent_name_tfidf_9       1290.671890
url_len                       1284.274063
body_tfidf_12                 1279.712368
body_tfidf_9                  1209.730761
body_tfidf_8                  1161.935181
url_name_tfidf_15             1158.114828
url_name_tfidf_7               998.550187
url_name_tfidf_0               998.193206
Name: importance, dtype: float64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xgb_params = &#123;&#x27;n_estimators&#x27;: 10000,</span></span><br><span class="line"><span class="comment">#               &#x27;learning_rate&#x27;: 0.03689407512484644,</span></span><br><span class="line"><span class="comment">#               &#x27;max_depth&#x27;: 8,</span></span><br><span class="line"><span class="comment">#               &#x27;objective&#x27;: &#x27;multi:softproba&#x27;,</span></span><br><span class="line"><span class="comment">#               &#x27;colsample_bytree&#x27;: 0.3723914688159835,</span></span><br><span class="line"><span class="comment">#               &#x27;subsample&#x27;: 0.780714581166012,</span></span><br><span class="line"><span class="comment">#               &#x27;eval_metric&#x27;: &#x27;mlogloss&#x27;,</span></span><br><span class="line"><span class="comment">#               &#x27;gamma&#x27;: 0,</span></span><br><span class="line"><span class="comment">#               &#x27;nthread&#x27;: 1,</span></span><br><span class="line"><span class="comment">#               &#x27;reg_lambda&#x27;: 50.0,</span></span><br><span class="line"><span class="comment">#               &#x27;random_state&#x27;: 42&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat_params = &#123;&#x27;iterations&#x27;: 8000,</span></span><br><span class="line"><span class="comment">#               &#x27;learning_rate&#x27;: 0.03429054860458741,</span></span><br><span class="line"><span class="comment">#               &#x27;reg_lambda&#x27;: 0.3242286463210283,</span></span><br><span class="line"><span class="comment">#               &#x27;subsample&#x27;: 0.9433911589913944,</span></span><br><span class="line"><span class="comment">#               &#x27;random_strength&#x27;: 22.4849972385133,</span></span><br><span class="line"><span class="comment">#               &#x27;depth&#x27;: 8,</span></span><br><span class="line"><span class="comment">#               &#x27;thread_count&#x27;: 1,</span></span><br><span class="line"><span class="comment">#               #         &#x27;min_data_in_leaf&#x27;: 4,</span></span><br><span class="line"><span class="comment">#               &#x27;leaf_estimation_iterations&#x27;: 8,</span></span><br><span class="line"><span class="comment">#               &#x27;task_type&#x27;: &quot;CPU&quot;,</span></span><br><span class="line"><span class="comment">#               &#x27;bootstrap_type&#x27;: &#x27;Bernoulli&#x27;,</span></span><br><span class="line"><span class="comment">#               &#x27;verbose&#x27;: 50,</span></span><br><span class="line"><span class="comment">#               &#x27;early_stopping_rounds&#x27;: 50,</span></span><br><span class="line"><span class="comment">#               # &#x27;eval_metric&#x27;: &#x27;AUC&#x27;,</span></span><br><span class="line"><span class="comment">#               &#x27;loss_function&#x27;:&#x27;MultiClass&#x27;</span></span><br><span class="line"><span class="comment">#               &#125;</span></span><br><span class="line"><span class="comment"># # lgb = LGBMClassifier(**lgb_params)</span></span><br><span class="line"><span class="comment"># xgb = XGBClassifier(**xgb_params)</span></span><br><span class="line"><span class="comment"># cat = CatBoostClassifier(**cat_params)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># # In[18]:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def get_oof(feats, target, test, kfold, clf):</span></span><br><span class="line"><span class="comment">#     oof_preds = np.zeros((feats.shape[0],6))</span></span><br><span class="line"><span class="comment">#     sub_preds = np.zeros((test.shape[0],6))</span></span><br><span class="line"><span class="comment">#     for i, (train_idx, valid_idx) in enumerate(kfold.split(feats, target)):</span></span><br><span class="line"><span class="comment">#         train_X, train_y = feats.loc[train_idx], target.loc[train_idx]</span></span><br><span class="line"><span class="comment">#         valid_X, valid_y = feats.loc[valid_idx], target.loc[valid_idx]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#         clf.fit(train_X, train_y, eval_set=[(valid_X, valid_y)], verbose=100, early_stopping_rounds=50, )</span></span><br><span class="line"><span class="comment">#         oof_preds[valid_idx] = clf.predict_proba(valid_X)</span></span><br><span class="line"><span class="comment">#         sub_preds += clf.predict_proba(test)</span></span><br><span class="line"><span class="comment">#         del train_X, train_y, valid_X, valid_y</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     evalution_result = accuracy_score(target, np.argmax(oof_preds,axis=1))</span></span><br><span class="line"><span class="comment">#     print(&#x27;*&#x27; * 10)</span></span><br><span class="line"><span class="comment">#     print(&#x27;roc auc score:&#x27;, evalution_result)</span></span><br><span class="line"><span class="comment">#     print(&#x27;*&#x27; * 20)</span></span><br><span class="line"><span class="comment">#     sub_preds_result = sub_preds / kfold.n_splits</span></span><br><span class="line"><span class="comment">#     return oof_preds, sub_preds_result</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># kfold = StratifiedKFold(n_splits=5, shuffle=True, random_state=2021)</span></span><br><span class="line"><span class="comment"># # 45开始</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oof_preds_2, sub_preds_2 = get_oof(train[feature_names], train[&#x27;label&#x27;], test[feature_names], kfold, xgb)i</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oof_preds_3, sub_preds_3 = get_oof(train[feature_names], train[&#x27;label&#x27;], test[feature_names], kfold, cat)</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub[<span class="string">&#x27;predict&#x27;</span>]=np.argmax(lgb_preds,axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub[<span class="string">&#x27;predict&#x27;</span>].value_counts()</span><br></pre></td></tr></table></figure>




<pre><code>2    855
1    828
0    804
3    666
4    447
5    400
Name: predict, dtype: int64
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sub.to_csv(&#x27;E:/data/DF/Web攻击检测与分类识别/res/9-8-1.csv&#x27;)</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">accuracy_score(train[<span class="string">&#x27;label&#x27;</span>],np.argmax(lgb_oof,axis=<span class="number">1</span>))</span><br></pre></td></tr></table></figure>




<pre><code>0.9883161303992494
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lgb</span></span><br><span class="line">f1_score(np.argmax(lgb_oof,axis=<span class="number">1</span>),train[<span class="string">&#x27;label&#x27;</span>],average= <span class="string">&#x27;macro&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># xgb</span></span><br><span class="line"><span class="comment"># f1_score(np.argmax(oof_preds_2,axis=1),train[&#x27;label&#x27;],average= &#x27;macro&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat</span></span><br><span class="line"><span class="comment"># f1_score(np.argmax(lgb_oof,axis=1),train[&#x27;label&#x27;],average= &#x27;macro&#x27;)</span></span><br></pre></td></tr></table></figure>




<pre><code>0.9650199644033531
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(classification_report(train[<span class="string">&#x27;label&#x27;</span>],np.argmax(lgb_oof,axis=<span class="number">1</span>)))</span><br></pre></td></tr></table></figure>

<pre><code>              precision    recall  f1-score   support

         0.0       0.99      1.00      1.00      6489
         1.0       0.99      0.99      0.99     14038
         2.0       0.99      0.99      0.99      9939
         3.0       0.94      0.93      0.94      1215
         4.0       0.94      0.87      0.90       697
         5.0       0.97      0.98      0.98       659

    accuracy                           0.99     33037
   macro avg       0.97      0.96      0.97     33037
weighted avg       0.99      0.99      0.99     33037
</code></pre>
<p>​    </p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
          
            <a href="/" rel="tag"><i class="fa fa-tags"></i> </a>
          
            <a href="/" rel="tag"><i class="fa fa-tags"></i> </a>
          
         </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/31537f8b.html" rel="prev" title="BERT梳理">
      <i class="fa fa-chevron-left"></i> BERT梳理
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/cfe29466.html" rel="next" title="第十章 双目视觉测量">
      第十章 双目视觉测量 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  







          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CCF-BDCI-Web%E6%94%BB%E5%87%BB%E6%A3%80%E6%B5%8B%E4%B8%8E%E5%88%86%E7%B1%BB%E8%AF%86%E5%88%AB-Top8%E6%80%9D%E8%B7%AF"><span class="nav-number">1.</span> <span class="nav-text">CCF BDCI Web攻击检测与分类识别 Top8思路</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%9B%E9%A2%98%E8%83%8C%E6%99%AF%EF%BC%9A"><span class="nav-number">1.1.</span> <span class="nav-text">赛题背景：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%9B%E9%A2%98%E4%BB%BB%E5%8A%A1%EF%BC%9A"><span class="nav-number">1.2.</span> <span class="nav-text">赛题任务：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%B3%E8%B5%9B%E7%AD%94%E8%BE%A9%EF%BC%9A"><span class="nav-number">1.3.</span> <span class="nav-text">决赛答辩：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%AE%80%E4%BB%8B"><span class="nav-number">1.4.</span> <span class="nav-text">数据简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%84%E6%B5%8B%E6%A0%87%E5%87%86"><span class="nav-number">1.5.</span> <span class="nav-text">评测标准</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B"><span class="nav-number">2.</span> <span class="nav-text">代码如下</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90"><span class="nav-number">3.</span> <span class="nav-text">数据分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%89%B9%E5%BE%81"><span class="nav-number">4.</span> <span class="nav-text">基础特征</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="江东"
      src="https://avatars.githubusercontent.com/u/76576534?v=4">
  <p class="site-author-name" itemprop="name">江东</p>
  <div class="site-description" itemprop="description">热爱生活，努力工作</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">97</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/du2279664786" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;du2279664786" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">江东</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.7' zIndex='-1' count='199' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

  <script async src="/js/cursor/fireworks.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
